<!DOCTYPE html>
<html>
<head>
    <title>PubMed Search Results</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</head>
<body>
    <button id="mode-toggle" class="toggle-button" onclick="toggleMode()">Toggle Mode</button>
    <h1>PubMed Search Results</h1>

    <ul>
        {% for article in article_details %}
        <li>
            <strong>PubMed ID:</strong> {{ article.pubmed_id }}<br>
            <strong>Title:</strong> {{ article.title }}<br>
            <button class="abstract-button" onclick="fetchAbstract('{{ article.pubmed_id }}')">Get Abstract</button>
            <div class="abstract-content" id="abstract-{{ article.pubmed_id }}" style="display: none;">
                <h3>Abstract</h3>
                <p>Loading...</p>
            </div>
            <a href="{{ article.url }}">Look up here!!!</a>
            <button class="author-button" onclick="showAuthors(this)">Authors</button>
            <div class="authors" style="display: none;">
                <strong>Authors:</strong> {{ article.authors|join(', ') }}
            </div>
        </li>
        {% endfor %}
    </ul>

    <div>
        <a href="{{ url_for('index') }}">Back to Search</a>
        {% if 'term' in request.form %}
        <a href="https://pubmed.ncbi.nlm.nih.gov/?term={{ request.form.term }}">Search All Results on NCBI</a>
        {% endif %}
    </div>

    {% if page < total_pages %}
    <form action="/search" method="post">
        <input type="hidden" name="term" value="{{ request.form.term }}">
        <input type="hidden" name="page" value="{{ page + 1 }}">
        <button type="submit">Search Next Page</button>
    </form>
    {% endif %}

    <script>
        function fetchAbstract(pubmedId) {
            var abstractDiv = document.getElementById('abstract-' + pubmedId);
            var abstractButton = document.querySelector(`button[data-pubmed-id="${pubmedId}"]`);
            if (abstractDiv.style.display === "none") {
                // Show loading message
                abstractDiv.innerHTML = '<h3>Abstract</h3><p>Loading...</p>';
                abstractDiv.style.display = "block";

                // Make an AJAX request to fetch the abstract
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        var response = JSON.parse(xhr.responseText);
                        if (response.abstract) {
                            // Display the abstract
                            abstractDiv.innerHTML = '<h3>Abstract</h3><p>' + response.abstract + '</p>';
                        } else {
                            // Display "Abstract Not Found"
                            abstractDiv.innerHTML = '<p>Abstract Not Found</p>';
                        }
                    } else if (xhr.readyState === 4 && xhr.status !== 200) {
                        // Display an error message
                        abstractDiv.innerHTML = '<p>Error fetching abstract</p>';
                    }
                };
                xhr.open("GET", "/abstract/" + pubmedId, true);
                xhr.send();
            } else {
                abstractDiv.style.display = "none";
            }
        }

        function showAuthors(button) {
            var authorsDiv = button.nextElementSibling;
            if (authorsDiv.style.display === "none") {
                authorsDiv.style.display = "block";
            } else {
                authorsDiv.style.display = "none";
            }
        }
    </script>
</body>
</html>
